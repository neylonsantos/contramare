# Nome do Workflow
name: Deploy Jekyll para Servidor

# Gatilhos que iniciam o workflow
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.8'
          bundler-cache: true

      # ValidaÃ§Ã£o das dependÃªncias
      - name: Verificar dependÃªncias
        run: |
          if [ ! -f "Gemfile" ]; then
            echo "âŒ Gemfile nÃ£o encontrado!"
            exit 1
          fi
          bundle install --jobs 4 --retry 3

      - name: Build do site com Jekyll
        run: |
          bundle exec jekyll build
          # Verifica se o build foi bem-sucedido
          if [ ! -d "_site" ] || [ -z "$(ls -A _site)" ]; then
            echo "âŒ Build falhou ou diretÃ³rio _site estÃ¡ vazio!"
            exit 1
          fi
          echo "âœ… Build concluÃ­do com sucesso"

      - name: Compactar arquivos do site
        run: tar -czf site.tar.gz -C _site .

      - name: Transferir arquivos para o servidor
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "site.tar.gz"
          target: "/tmp"

      - name: Deploy no servidor
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e  # Para em caso de erro

            TARGET_DIR="/contramare_com_br"
            BACKUP_DIR="${TARGET_DIR}_backup_$(date +%Y%m%d_%H%M%S)"

            echo "ðŸš€ Iniciando deploy em ${TARGET_DIR}..."

            # Verifica se o arquivo foi transferido
            if [ ! -f "/tmp/site.tar.gz" ]; then
              echo "âŒ Arquivo site.tar.gz nÃ£o encontrado!"
              exit 1
            fi

            # Cria diretÃ³rio de destino se nÃ£o existir
            mkdir -p ${TARGET_DIR}

            # Backup mais robusto
            if [ "$(ls -A ${TARGET_DIR} 2>/dev/null | head -1)" ]; then
              echo "ðŸ“¦ Criando backup em ${BACKUP_DIR}..."
              cp -r ${TARGET_DIR} ${BACKUP_DIR}
            fi

            # Limpa diretÃ³rio atual
            echo "ðŸ§¹ Limpando diretÃ³rio atual..."
            rm -rf ${TARGET_DIR}/*
            rm -rf ${TARGET_DIR}/.[!.]*

            # Extrai novos arquivos
            echo "ðŸ“‚ Extraindo novos arquivos..."
            tar -xzf /tmp/site.tar.gz -C ${TARGET_DIR}

            # Verifica se a extraÃ§Ã£o foi bem-sucedida
            if [ ! "$(ls -A ${TARGET_DIR})" ]; then
              echo "âŒ Falha na extraÃ§Ã£o! Restaurando backup..."
              if [ -d "${BACKUP_DIR}" ]; then
                cp -r ${BACKUP_DIR}/* ${TARGET_DIR}/
                cp -r ${BACKUP_DIR}/.[!.]* ${TARGET_DIR}/ 2>/dev/null || true
              fi
              exit 1
            fi

            # Ajusta permissÃµes
            echo "ðŸ” Ajustando permissÃµes..."
            find ${TARGET_DIR} -type f -exec chmod 644 {} \;
            find ${TARGET_DIR} -type d -exec chmod 755 {} \;

            # Limpeza
            echo "ðŸ§½ Removendo arquivos temporÃ¡rios..."
            rm -f /tmp/site.tar.gz

            # MantÃ©m apenas os 5 backups mais recentes
            echo "ðŸ—‚ï¸ Limpando backups antigos..."
            ls -dt /contramare_com_br_backup_* 2>/dev/null | tail -n +6 | xargs rm -rf

            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ðŸ“Š ConteÃºdo atual:"
            ls -alh ${TARGET_DIR} | head -10